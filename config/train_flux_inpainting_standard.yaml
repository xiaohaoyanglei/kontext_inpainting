---
job: extension
config:
  # è®­ç»ƒä»»åŠ¡åç§°ï¼Œå°†ä½œä¸ºè¾“å‡ºæ–‡ä»¶å¤¹åç§°
  name: "flux_inpainting_standard_v1"
  process:
    - type: 'sd_trainer'  # ä½¿ç”¨æ ‡å‡†çš„SDè®­ç»ƒå™¨
      # è¾“å‡ºæ–‡ä»¶å¤¹
      training_folder: "output"
      # è®­ç»ƒè®¾å¤‡
      device: cuda:0
      
      # ä¿å­˜é…ç½®
      save:
        dtype: bf16  # ä¿å­˜ç²¾åº¦
        save_every: 250  # æ¯250æ­¥ä¿å­˜ä¸€æ¬¡
        max_step_saves_to_keep: 4  # ä¿ç•™æœ€è¿‘4ä¸ªæ£€æŸ¥ç‚¹
      
      # æ•°æ®é›†é…ç½® - å…³é”®éƒ¨åˆ†ï¼
      datasets:
        # AI-toolkitçš„æ ‡å‡†inpaintingæ•°æ®é›†é…ç½®
        # ğŸ”§ è¯·æ ¹æ®æ‚¨çš„å®é™…è·¯å¾„ä¿®æ”¹ä»¥ä¸‹ä¸‰ä¸ªè·¯å¾„
        - folder_path: "data/target_images"     # ç›®æ ‡å›¾åƒæ–‡ä»¶å¤¹ï¼ˆå®Œæ•´å›¾åƒï¼‰
          # inpaintingç‰¹æ®Šé…ç½®
          inpaint_path: "data/masked_images"    # å¸¦æ´å›¾åƒæ–‡ä»¶å¤¹
          mask_path: "data/masks"              # æ©ç æ–‡ä»¶å¤¹
          
          # æ–‡æœ¬æè¿°é…ç½®
          caption_ext: "txt"
          caption_dropout_rate: 0.05  # 5%çš„æ¦‚ç‡ä¸¢å¼ƒæ–‡æœ¬æè¿°
          
          # ğŸ”¥ å…³é”®ä¼˜åŒ–ï¼šé¢„ç¼“å­˜latentsåˆ°ç£ç›˜
          cache_latents_to_disk: true  # é¢„å¤„ç†VAEç¼–ç ï¼Œå¤§å¹…å‡å°‘æ˜¾å­˜å’Œæå‡é€Ÿåº¦
          
          # å¤šåˆ†è¾¨ç‡è®­ç»ƒ
          resolution: [512, 768, 1024]  # FLUXæ”¯æŒå¤šåˆ†è¾¨ç‡
          
          # å›¾åƒå¤„ç†
          shuffle_tokens: false
          buckets: true  # å¯ç”¨æ¡¶åŒ–ä»¥å¤„ç†ä¸åŒå°ºå¯¸
      
      # è®­ç»ƒé…ç½®
      train:
        # æ‰¹æ¬¡å’Œç´¯ç§¯
        batch_size: 1  # ç”±äºæ˜¯å…¨æ¨¡å‹å¾®è°ƒï¼Œä½¿ç”¨å°æ‰¹æ¬¡
        gradient_accumulation_steps: 4  # æ¢¯åº¦ç´¯ç§¯ï¼Œç­‰æ•ˆæ‰¹æ¬¡å¤§å°4
        
        # è®­ç»ƒç›®æ ‡
        train_unet: true  # è®­ç»ƒFLUX transformer
        train_text_encoder: false  # ä¸è®­ç»ƒæ–‡æœ¬ç¼–ç å™¨
        
        # ä¼˜åŒ–å™¨å’Œå­¦ä¹ ç‡
        optimizer: "adamw8bit"  # 8bitä¼˜åŒ–å™¨èŠ‚çœæ˜¾å­˜
        lr: 1e-4
        
        # è®­ç»ƒæ­¥æ•°
        steps: 2000  # æ€»è®­ç»ƒæ­¥æ•°
        
        # æ˜¾å­˜ä¼˜åŒ–
        gradient_checkpointing: true  # æ¢¯åº¦æ£€æŸ¥ç‚¹
        
        # FLUXç‰¹å®šé…ç½®
        noise_scheduler: "flowmatch"  # FLUXä½¿ç”¨flow matching
        timestep_type: "flux_shift"   # FLUXæ—¶é—´æ­¥ç±»å‹
        
        # æ··åˆç²¾åº¦
        dtype: bf16
        
        # EMAå¹³æ»‘
        ema_config:
          use_ema: true
          ema_decay: 0.99
      
      # æ¨¡å‹é…ç½®
      model:
        # FLUX.1-devæ¨¡å‹
        name_or_path: "black-forest-labs/FLUX.1-dev"
        is_flux: true
        quantize: true  # 8bité‡åŒ–ä»¥èŠ‚çœæ˜¾å­˜
        
        # ğŸ”¥ å¦‚æœæ˜¯å…¨æ¨¡å‹å¾®è°ƒï¼Œå–æ¶ˆä¸‹é¢çš„æ³¨é‡Š
        # åªè®­ç»ƒtransformer blocksï¼Œä¸è®­ç»ƒå…¶ä»–ç»„ä»¶
        # only_if_contains: 
        #   - "transformer_blocks."
        #   - "single_transformer_blocks."
      
      # é‡‡æ ·é…ç½®ï¼ˆç”¨äºè®­ç»ƒè¿‡ç¨‹ä¸­çš„é¢„è§ˆï¼‰
      sample:
        sampler: "flowmatch"  # å¿…é¡»åŒ¹é…è®­ç»ƒçš„noise_scheduler
        sample_every: 250  # æ¯250æ­¥ç”Ÿæˆä¸€æ¬¡é¢„è§ˆ
        width: 1024
        height: 1024
        prompts:
          - "a beautiful landscape with mountains and lakes"
          - "a portrait of a person in artistic style"
          - "architectural building with modern design"
          - "still life with flowers and fruits"
        neg: ""  # FLUXä¸ä½¿ç”¨è´Ÿé¢æç¤º
        seed: 42
        walk_seed: true
        guidance_scale: 4  # FLUXçš„å¼•å¯¼å¼ºåº¦
        sample_steps: 20

# å…ƒæ•°æ®
meta:
  name: "[name]"
  version: '1.0'
  description: "FLUX.1-dev inpainting fine-tuning using standard sd_trainer"
  author: "AI-Toolkit Migration" 